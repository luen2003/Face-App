<!DOCTYPE html>
<html>

<head>
    <title>Face Recognition App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="container mt-5">

    <h2>Face Recognition & Analysis</h2>

    <!-- Th√¥ng b√°o -->
    {% if message %}
    <div class="alert alert-info">{{ message }}</div>
    {% endif %}

    <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label>Ch·ªçn ch·∫ø ƒë·ªô:</label>
            <select class="form-select" name="upload_type" id="upload_type" onchange="toggleNameField()" required>
                <option value="add">üìÅ Th√™m ·∫£nh v√†o th∆∞ vi·ªán</option>
                <option value="analyze">üîç Ph√¢n t√≠ch & nh·∫≠n di·ªán</option>
            </select>
        </div>

        <div class="mb-3" id="name_field">
            <label>Nh·∫≠p t√™n ng∆∞·ªùi:</label>
            <input type="text" class="form-control" name="person_name" placeholder="V√≠ d·ª•: TaDinhLuong">
        </div>

        <div class="mb-3">
            <label>Ch·ªçn ·∫£nh t·ª´ m√°y:</label>
            <input type="file" class="form-control" name="file" accept="image/*">
        </div>

        <div class="mb-3">
            <label>Ho·∫∑c ch·ª•p ·∫£nh tr·ª±c ti·∫øp:</label><br>
            <video id="video" width="320" height="240" autoplay></video><br>
            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="capture()">üì∑ Ch·ª•p ·∫£nh</button>
            <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="stopCamera()">T·∫Øt camera</button>
            <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="startCamera()">B·∫≠t
                camera</button>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <input type="hidden" name="image_data" id="image_data">

            <div class="mt-2" id="preview" style="display: none;">
                <label>·∫¢nh v·ª´a ch·ª•p:</label><br>
                <img id="captured_image" src="" width="320" height="240" class="border">
            </div>
        </div>

        <button type="submit" class="btn btn-success">G·ª≠i ·∫£nh</button>
    </form>

    {% if result %}
    <hr>
    <h3>K·∫øt qu·∫£ ph√¢n t√≠ch:</h3>
    <div class="row">
        {% if matched_filename %}
        <div class="col-md-4">
            <p><strong>ƒê·ªëi chi·∫øu v·ªõi:</strong></p>
            <img src="{{ matched_filename }}" width="200" />
        </div>
        {% endif %}

        {% if captured_image %}
        <div class="col-md-4">
            <p><strong>·∫¢nh ph√¢n t√≠ch (·∫£nh m·ªõi):</strong></p>
            <img src="{{ captured_image }}" width="200" />
        </div>
        {% endif %}
    </div>
    <ul class="list-group mt-3">
        <li class="list-group-item"><strong>T√™n:</strong> {{ name }}</li>
        <li class="list-group-item"><strong>Tu·ªïi:</strong> {{ result.age }}</li>
        <li class="list-group-item"><strong>Gi·ªõi t√≠nh:</strong> {{ result.gender }}</li>
        <li class="list-group-item"><strong>C·∫£m x√∫c:</strong> {{ result.emotion }}</li>
    </ul>
    {% endif %}

    <script>
        let mediaStream = null;

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    mediaStream = stream;
                    document.getElementById('video').srcObject = stream;
                })
                .catch(function (error) {
                    console.error("Kh√¥ng th·ªÉ b·∫≠t camera: ", error);
                });
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                document.getElementById('video').srcObject = null;
            }
        }

        function capture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataURL = canvas.toDataURL('image/jpeg');
            document.getElementById('image_data').value = dataURL;

            const img = document.getElementById('captured_image');
            img.src = dataURL;
            document.getElementById('preview').style.display = 'block';
        }

        function toggleNameField() {
            const uploadType = document.getElementById('upload_type').value;
            const nameField = document.getElementById('name_field');
            nameField.style.display = (uploadType === 'add') ? 'block' : 'none';
        }

        window.onload = function () {
            toggleNameField();
            startCamera();
        };
    </script>
</body>

</html>